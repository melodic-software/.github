# Last reviewed: 2026-01-16
name: Cross-Repo Label Sync

# Syncs labels from labels.yaml to all organization repositories
# Uses matrix strategy to process repos sequentially (avoids GitHub API rate limits)
#
# REQUIRED: LABEL_SYNC_PAT repository secret with 'Issues: Read and write' permission
# See: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens

on:
  push:
    branches: [main]
    paths:
      - 'labels.yaml'
  workflow_dispatch:
    inputs:
      clean-labels:
        description: 'Remove labels not in config (dangerous - use with caution!)'
        required: false
        type: boolean
        default: false

# Minimal permissions - PAT provides cross-repo access
permissions:
  contents: read

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Validate LABEL_SYNC_PAT secret exists
        env:
          LABEL_SYNC_PAT: ${{ secrets.LABEL_SYNC_PAT }}
        run: |
          if [ -z "$LABEL_SYNC_PAT" ]; then
            echo "::error::LABEL_SYNC_PAT secret is not configured!"
            echo ""
            echo "This workflow requires a LABEL_SYNC_PAT secret with 'Issues: Read and write' permission."
            echo ""
            echo "To fix this:"
            echo "1. Create a Fine-grained PAT at: https://github.com/settings/personal-access-tokens/new"
            echo "   - Resource owner: melodic-software"
            echo "   - Repository access: All repositories"
            echo "   - Permissions: Issues (Read and write)"
            echo "2. Add it as a repository secret named 'LABEL_SYNC_PAT' at:"
            echo "   https://github.com/melodic-software/.github/settings/secrets/actions"
            echo ""
            exit 1
          fi
          echo "LABEL_SYNC_PAT secret is configured"

  sync:
    name: Sync to ${{ matrix.repo }}
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 5

    strategy:
      fail-fast: false
      max-parallel: 1  # Process one repo at a time to avoid rate limits
      matrix:
        repo:
          - melodic-software/medley
          - melodic-software/citadel
          - melodic-software/identity-server
          - melodic-software/membrain

    steps:
      - name: Checkout labels configuration
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            labels.yaml
          sparse-checkout-cone-mode: false

      - name: Sync labels to ${{ matrix.repo }}
        uses: srealmoreno/label-sync-action@v2
        with:
          token: ${{ secrets.LABEL_SYNC_PAT }}
          repositories: ${{ matrix.repo }}
          config-file: labels.yaml
          clean-labels: ${{ inputs.clean-labels || false }}

  summary:
    name: Generate Summary
    needs: sync
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate job summary
        run: |
          echo "# Cross-Repository Label Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Target Repositories" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| melodic-software/medley | ${{ needs.sync.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| melodic-software/citadel | ${{ needs.sync.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| melodic-software/identity-server | ${{ needs.sync.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| melodic-software/membrain | ${{ needs.sync.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: \`labels.yaml\` in \`.github\` repository" >> $GITHUB_STEP_SUMMARY
          echo "- **Clean Labels**: ${{ inputs.clean-labels || false }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action**: [srealmoreno/label-sync-action@v2](https://github.com/srealmoreno/label-sync-action)" >> $GITHUB_STEP_SUMMARY
